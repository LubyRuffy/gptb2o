# AGENTS.md

本文件用于约束与指导在本仓库中工作的自动化代理/协作开发流程，目标是：**保证可编译、可测试、可维护，并把每次发现的问题沉淀为可复用的规则**。

## 规则（硬性）

1. 永远用中文输出响应。
2. 修改代码后需要确保代码可以编译通过；若项目包含前端与后端，改了前端文件就确保前端能够编译，改了后端文件就确保后端能够编译。
3. 添加后端代码后，新增和修改的函数需要确保单元测试覆盖且通过。
4. 前端样式默认不新增新的类和硬编码样式，需通过 shadcn 组件或变量控制，确保体验一致。
5. 修复与上游/外部 API 行为相关的问题时，必须先用“最小请求”（例如 `curl`）在本地复现并确认触发条件；不能只依据客户端日志/抓包内容做推断。
6. 若复现/验证依赖真实网络与凭据（token），必须先提供一个默认跳过的真实后端集成测试（通过环境变量显式开启），在链路跑通后再补 `httptest` mock 的稳定回归测试。
7. 在关键假设尚未验证前，不得把推断当结论；需要明确标注“待验证”并先告知用户验证计划与需要的前置条件（例如环境变量、账号权限、网络依赖）。

## Go 质量门禁（建议每次改动后执行）

优先使用脚本：

```bash
./scripts/go_quality_check.sh
```

可选项：

- `FIX=1`：自动 gofmt（必要时）并继续检查。
- `RACE=1`：附加执行 `go test -race ./...`（本地耗时更长）。

## 自我学习与进化（持续迭代机制）

目标：把“本次发现的问题”转成“下次自动避免的问题”。

### 使用方式

运行学习脚本（会跑质量检查、保存日志、并把摘要追加到本文件的学习日志区）：

```bash
./scripts/agent_learn.sh
```

产物默认保存到 `artifacts/agent-learning/<timestamp>/`，可安全忽略提交。

### 迭代规则

当出现以下情况时，必须更新本文件（在“学习日志”里记录，并在需要时调整上面的“规则/门禁”）：

- 修复了静态检查（`go vet`/`staticcheck`/`golangci-lint`）问题
- 修复了测试不稳定/竞态（race）
- 修复了线上/用户反馈的 bug（需要明确根因与预防措施）
- 引入了新的约定（例如错误包装、context 传递、并发生命周期约束等）

### 学习日志（自动追加）

<!-- LEARNING_LOG_START -->

## 20260209-123427 经验教训：Issue #1 `/v1/responses` 400 `Instructions are required`

- 最初误判原因：过度依赖 issue body 里 Cherry Studio 的 `"[undefined]"` 请求体日志，把它当作主要触发条件；没有先用最小化 `curl` 验证“即使不带 instructions 也会 400”这一事实。
- 流程错误：在没有确认真实后端要求前就先落代码并补了基于 `httptest` 的集成测试；mock 测试数据是“自洽的”，但并不能证明对真实 backend 生效，导致验证顺序颠倒。
- 过程沟通不足：在关键假设未验证时，没有先向用户明确说明“需要先用真实后端跑通（可能依赖 token/网络）”的门槛与计划，造成偏差与返工。
- 纠正措施（已执行/纳入规则）：将“先最小请求复现确认”与“真实后端可选集成测试先行，再 mock 回归”的约束写入本文件规则第 5-7 条。

## 20260209-115725 质量检查与学习摘要

- 结果：PASS
- 日志：`artifacts/agent-learning/20260209-115725/quality.log`

- 本次未发现需要修复的质量问题。

<!-- LEARNING_LOG_END -->
